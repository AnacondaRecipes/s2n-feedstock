From 5cbac0fe236efbf00e6be6c469407045e4d8b5e6 Mon Sep 17 00:00:00 2001
From: Torben Hansen <50673096+torben-hansen@users.noreply.github.com>
Date: Mon, 4 Apr 2022 15:56:44 -0700
Subject: [PATCH] Fix wrong assumption about osx/apple

---
 tests/unit/s2n_fork_generation_number_test.c | 8 +++++++-
 utils/s2n_fork_detection.c                   | 4 ----
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/tests/unit/s2n_fork_generation_number_test.c b/tests/unit/s2n_fork_generation_number_test.c
index ae3f0c40ac..93faa0d5a1 100644
--- a/tests/unit/s2n_fork_generation_number_test.c
+++ b/tests/unit/s2n_fork_generation_number_test.c
@@ -45,8 +45,14 @@ struct fgn_test_case {
 static void s2n_verify_child_exit_status(pid_t proc_pid)
 {
     int status = 0;
+#if defined(S2N_CLONE_SUPPORTED)
     EXPECT_EQUAL(waitpid(proc_pid, &status, __WALL), proc_pid);
-
+#else
+    /* __WALL is not relevant when clone() is not supported
+     * https://man7.org/linux/man-pages/man2/wait.2.html#NOTES
+     */
+    EXPECT_EQUAL(waitpid(proc_pid, &status, 0), proc_pid);
+#endif
     /* Check that child exited with EXIT_SUCCESS. If not, this indicates
      * that an error was encountered in the unit tests executed in that
      * child process.
diff --git a/utils/s2n_fork_detection.c b/utils/s2n_fork_detection.c
index 68ca0d9296..c24a84197b 100644
--- a/utils/s2n_fork_detection.c
+++ b/utils/s2n_fork_detection.c
@@ -42,10 +42,6 @@
 #include <unistd.h>
 
 
-#if defined(S2N_MINHERIT_SUPPORTED) && defined(S2N_MADVISE_SUPPORTED)
-#error "Both S2N_MINHERIT_SUPPORTED and S2N_MADVISE_SUPPORTED are defined. This should not be possible."
-#endif
-
 #if defined(S2N_MADVISE_SUPPORTED) && defined(MADV_WIPEONFORK)
 #if (MADV_WIPEONFORK != 18)
 #error "MADV_WIPEONFORK is not 18"
